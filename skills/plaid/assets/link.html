<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Plaid — Manage Accounts</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      min-height: 100vh; background: #f5f5f5; color: #333;
      display: flex; justify-content: center; padding: 2rem;
    }
    .container { max-width: 520px; width: 100%; }
    h1 { font-size: 1.5rem; margin-bottom: 0.25rem; }
    .subtitle { color: #666; margin-bottom: 1.5rem; font-size: 0.95rem; }
    button {
      background: #000; color: #fff; border: none; padding: 0.6rem 1.5rem;
      border-radius: 8px; font-size: 0.95rem; cursor: pointer;
    }
    button:hover { background: #333; }
    button:disabled { background: #999; cursor: not-allowed; }
    .btn-sm {
      background: none; color: #dc2626; border: 1px solid #dc2626;
      padding: 0.3rem 0.75rem; font-size: 0.8rem; border-radius: 6px;
    }
    .btn-sm:hover { background: #fef2f2; }
    .section { margin-top: 2rem; }
    .section h2 { font-size: 1.1rem; margin-bottom: 0.75rem; }
    .item-card {
      background: #fff; border: 1px solid #e5e5e5; border-radius: 10px;
      padding: 1rem; margin-bottom: 0.75rem;
    }
    .item-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 0.5rem;
    }
    .item-header strong { font-size: 1rem; }
    .item-header .date { color: #999; font-size: 0.8rem; }
    .acct-list { list-style: none; }
    .acct-list li {
      padding: 0.25rem 0; font-size: 0.9rem; color: #555;
      display: flex; justify-content: space-between;
    }
    .acct-list .mask { color: #999; }
    .empty { color: #999; font-style: italic; }
    .status { margin-top: 1rem; font-size: 0.9rem; }
    .success { color: #16a34a; }
    .error { color: #dc2626; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Plaid Accounts</h1>
    <p class="subtitle">Connect and manage your bank accounts.</p>

    <button id="connect-btn" disabled>Loading...</button>
    <div id="status" class="status"></div>

    <div class="section">
      <h2>Connected Institutions</h2>
      <div id="items-list"><p class="empty">Loading...</p></div>
    </div>
  </div>

  <script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
  <script>
    const btn = document.getElementById('connect-btn')
    const status = document.getElementById('status')
    const itemsList = document.getElementById('items-list')
    let plaidHandler = null

    async function loadAccounts() {
      try {
        const res = await fetch('/api/accounts')
        const { items } = await res.json()
        if (!items.length) {
          itemsList.innerHTML = '<p class="empty">No accounts connected yet.</p>'
          return
        }
        itemsList.innerHTML = items.map(item => `
          <div class="item-card" data-item-id="${item.item_id}">
            <div class="item-header">
              <strong>${item.institution_name}</strong>
              <button class="btn-sm" onclick="removeItem('${item.item_id}', '${item.institution_name}')">Remove</button>
            </div>
            <ul class="acct-list">
              ${item.accounts.map(a => `
                <li>
                  <span>${a.name} (${a.subtype || a.type})</span>
                  <span class="mask">···${a.mask}</span>
                </li>
              `).join('')}
            </ul>
          </div>
        `).join('')
      } catch (err) {
        itemsList.innerHTML = `<p class="error">Failed to load: ${err.message}</p>`
      }
    }

    async function removeItem(itemId, name) {
      if (!confirm(`Remove ${name} and all its accounts?`)) return
      try {
        const res = await fetch(`/api/accounts/${itemId}`, { method: 'DELETE' })
        const data = await res.json()
        if (data.success) {
          status.innerHTML = `<p class="success">Removed ${name}</p>`
          loadAccounts()
        } else {
          status.innerHTML = `<p class="error">${data.error}</p>`
        }
      } catch (err) {
        status.innerHTML = `<p class="error">Remove failed: ${err.message}</p>`
      }
    }

    async function initPlaid() {
      const res = await fetch('/api/create-link-token', { method: 'POST' })
      const { link_token } = await res.json()

      plaidHandler = Plaid.create({
        token: link_token,
        onSuccess: async (publicToken, metadata) => {
          status.textContent = 'Connecting...'
          try {
            const exchRes = await fetch('/api/exchange-token', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                public_token: publicToken,
                institution_name: metadata.institution?.name || 'Unknown',
              }),
            })
            const result = await exchRes.json()
            if (result.success) {
              status.innerHTML = `<p class="success">Connected ${result.accounts.length} account(s)!</p>`
              loadAccounts()
              // Re-init handler so user can connect another
              initPlaid()
            } else {
              status.innerHTML = `<p class="error">Error: ${result.error}</p>`
            }
          } catch (err) {
            status.innerHTML = `<p class="error">Exchange failed: ${err.message}</p>`
          }
        },
        onExit: (err) => {
          if (err) status.innerHTML = `<p class="error">Link exited: ${err.display_message || err.error_code}</p>`
        },
      })

      btn.textContent = '+ Connect Bank'
      btn.disabled = false
      btn.onclick = () => plaidHandler.open()
    }

    loadAccounts()
    initPlaid().catch(err => {
      status.innerHTML = `<p class="error">Failed to initialize: ${err.message}</p>`
    })
  </script>
</body>
</html>
